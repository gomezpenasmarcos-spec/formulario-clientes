<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reserva tu cita</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f3f3f3;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
  }

  .container{
    background:#fff;
    padding:40px;
    border-radius:20px;
    width:420px;
    box-shadow:0 10px 30px rgba(0,0,0,.10);
  }

  h2{
    text-align:center;
    font-size:32px;
    margin-bottom:30px;
  }

  .field{ margin-bottom:22px; position:relative; }

  label{
    display:block;
    font-size:16px;
    margin-bottom:6px;
  }

  input, textarea, select{
    width:100%;
    padding:14px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:18px;
    box-sizing:border-box;
    outline:none;
    background:#fff;
  }

  textarea{ resize:none; }

  /* TEL√âFONO */
  .phone-wrapper{
    display:flex;
    border:1px solid #ccc;
    border-radius:12px;
    height:54px;
    background:#fff;
    overflow:hidden; /* esquinas perfectas */
  }

  .flag-box{
    width:70px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-right:1px solid #ddd;
    cursor:pointer;
    user-select:none;
    background:#fff;
    flex:0 0 70px;
  }

  .flag-box img{
    width:28px;
    height:20px;
    border-radius:3px;
    object-fit:cover;
  }

  .prefix{
    display:flex;
    align-items:center;
    padding:0 10px;
    font-size:18px;
    color:#444;
    white-space:nowrap;
  }

  .phone-input{
    flex:1;
    border:none;
    outline:none;
    font-size:18px;
    padding:14px 14px 14px 6px;
    min-width:0;
  }

  /* Dropdown (fuera del wrapper para no romper border-radius) */
  .flag-dropdown{
    position:absolute;
    top:78px;
    left:0;
    width:340px;
    max-height:320px;
    overflow:auto;
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    display:none;
    z-index:999999;
    border:1px solid #eee;
  }

  .flag-search{
    position:sticky;
    top:0;
    background:#fff;
    padding:10px;
    border-bottom:1px solid #eee;
  }

  .flag-search input{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:16px;
    outline:none;
  }

  .flag-option{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    cursor:pointer;
  }

  .flag-option:hover{ background:#f3f5f9; }

  .flag-option img{
    width:26px;
    height:18px;
    border-radius:3px;
    object-fit:cover;
  }

  .country-name{
    flex:1;
    font-size:14px;
    color:#333;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .dial{
    font-size:14px;
    font-weight:600;
    color:#111;
    white-space:nowrap;
  }

  button{
    width:100%;
    padding:16px;
    border-radius:14px;
    border:none;
    background:#2f5bd7;
    color:#fff;
    font-size:22px;
    cursor:pointer;
  }

  button:hover{ background:#264cc0; }

  .status{
    margin-top:12px;
    font-size:16px;
    display:none;
  }

  .status.ok{ color:#15803d; display:block; }
  .status.err{ color:#b91c1c; display:block; }

  .hint{
    margin-top:6px;
    font-size:13px;
    color:#6b7280;
  }
  .hint.bad{ color:#b91c1c; }
  .hint.good{ color:#15803d; }
</style>

<script src="https://unpkg.com/libphonenumber-js@1.11.7/bundle/libphonenumber-js.min.js"></script>
</head>

<body>

<div class="container">
  <h2>Reserva tu cita</h2>

  <form id="form" novalidate>

    <div class="field">
      <label>Nombre</label>
      <input id="nombre" type="text" placeholder="Nombre completo" required>
    </div>

    <div class="field">
      <label>Correo electr√≥nico</label>
      <input id="email" type="email" placeholder="Correo electr√≥nico" required>
    </div>

    <div class="field" id="phoneField">
      <label>Tel√©fono</label>

      <div class="phone-wrapper">
        <div class="flag-box" id="flagBox" title="Cambiar pa√≠s">
          <img id="currentFlag" src="https://flagcdn.com/w40/es.png" alt="ES">
        </div>

        <div class="prefix" id="prefix">+34</div>
        <input id="telefono" class="phone-input" type="tel" placeholder="654 654 654" required inputmode="numeric" autocomplete="tel">
      </div>

      <div class="flag-dropdown" id="flagDropdown">
        <div class="flag-search">
          <input id="countrySearch" type="text" placeholder="Buscar pa√≠s o prefijo (+34)">
        </div>
        <div id="countriesList"></div>
      </div>

      <div class="hint" id="phoneHint">Introduce un n√∫mero v√°lido.</div>
    </div>

    <div class="field">
      <label>Selecciona el d√≠a</label>
      <input id="fecha" type="date" required>
    </div>

    <div class="field">
      <label>Selecciona la hora</label>
      <select id="hora" required></select>
    </div>

    <div class="field">
      <label>Motivo</label>
      <textarea id="mensaje" rows="3" placeholder="Escribe el motivo de la cita" required></textarea>
    </div>

    <button type="submit" id="submitBtn">Reservar</button>
    <div id="status" class="status"></div>

  </form>
</div>

<script>
  const WEBHOOK = "https://primary-production-4f93b.up.railway.app/webhook/cb0b99ce-d952-4988-84fd-708c61c1d9e6";

  // ===== DOM =====
  const form = document.getElementById("form");
  const nombreEl = document.getElementById("nombre");
  const emailEl = document.getElementById("email");
  const telInput = document.getElementById("telefono");
  const phoneHint = document.getElementById("phoneHint");
  const statusEl = document.getElementById("status");

  const fechaEl = document.getElementById("fecha");
  const horaEl = document.getElementById("hora");

  const flagBox = document.getElementById("flagBox");
  const dropdown = document.getElementById("flagDropdown");
  const countriesList = document.getElementById("countriesList");
  const countrySearch = document.getElementById("countrySearch");
  const currentFlag = document.getElementById("currentFlag");
  const prefixEl = document.getElementById("prefix");

  // ===== FECHA: bloquear pasados (min local + revalidaci√≥n) =====
  function localDateYYYYMMDD(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function todayLocal(){
    const t = new Date();
    t.setHours(0,0,0,0);
    return t;
  }
  function setMinDateToToday(){
    fechaEl.min = localDateYYYYMMDD(todayLocal());
  }
  function enforceDateNotPast(){
    if(!fechaEl.value) return true;
    const picked = new Date(fechaEl.value + "T00:00:00");
    const t = todayLocal();
    if(picked < t){
      fechaEl.value = localDateYYYYMMDD(t);
      return false;
    }
    return true;
  }
  setMinDateToToday();
  setInterval(setMinDateToToday, 60_000);
  fechaEl.addEventListener("focus", ()=>{ setMinDateToToday(); enforceDateNotPast(); });
  fechaEl.addEventListener("change", ()=>{ setMinDateToToday(); enforceDateNotPast(); });

  // ===== HORA: 07:00‚Äì23:30 (cada 30 min) =====
  horaEl.innerHTML = "";
  for(let h=7; h<24; h++){
    ["00","30"].forEach(m=>{
      const t = String(h).padStart(2,"0")+":"+m;
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      horaEl.appendChild(opt);
    });
  }

  // ===== PA√çSES (todos) + autodetect por IP =====
  let selectedCountry = "ES";
  let selectedDial = "+34";
  let countries = [];

  // L√≠mite ‚Äúduro‚Äù por pa√≠s (cuando lo sepamos). Si no, fallback 15.
  // Nota: esto limita la ENTRADA, y luego la librer√≠a valida si es real.
  const hardMaxByCountry = {
    ES: 9, FR: 9, PT: 9, IT: 10, GB: 10,
    US: 10, CA: 10, MX: 10, AR: 10, BR: 11,
    CO: 10, CL: 9, PE: 9,
    DE: 11, NL: 9, BE: 9, CH: 9,
    SE: 9, NO: 8, DK: 8, FI: 9, IE: 9,
    PL: 9, CZ: 9, RO: 9, GR: 10, TR: 10, UA: 9,
    RU: 10, BY: 9, AT: 10, HU: 9, SK: 9, HR: 9, SI: 8, BG: 9,
    LT: 8, LV: 8, EE: 7, IS: 7, LU: 9, MT: 8, CY: 8
  };

  function getMaxDigitsForCountry(country){
    return hardMaxByCountry[country] || 15;
  }
  let currentMaxDigits = getMaxDigitsForCountry(selectedCountry);

  function hintTextForMax(){
    return `Introduce un n√∫mero v√°lido. M√°x: ${currentMaxDigits} d√≠gitos.`;
  }
  phoneHint.textContent = hintTextForMax();

  function openDropdown(){
    dropdown.style.display = "block";
    countrySearch.value = "";
    renderCountries("");
    setTimeout(()=>countrySearch.focus(), 0);
  }
  function closeDropdown(){ dropdown.style.display = "none"; }

  flagBox.addEventListener("click", (e)=>{
    e.stopPropagation();
    if(dropdown.style.display === "block") closeDropdown();
    else openDropdown();
  });
  dropdown.addEventListener("click", (e)=>e.stopPropagation());
  countrySearch.addEventListener("click",(e)=>e.stopPropagation());
  document.addEventListener("click", ()=>closeDropdown());

  countrySearch.addEventListener("input", (e)=>renderCountries(e.target.value));

  async function loadCountries(){
    // Trae TODOS los pa√≠ses (restcountries). Si falla, al menos Espa√±a queda.
    const res = await fetch("https://restcountries.com/v3.1/all?fields=cca2,name,idd,flags");
    const data = await res.json();

    const list = [];
    for(const c of data){
      const iso2 = (c.cca2 || "").toUpperCase();
      if(!iso2) continue;

      const root = c.idd?.root || "";
      const suffixes = c.idd?.suffixes || [];
      if(!root || !root.startsWith("+")) continue;

      // Prefijo ‚Äúprincipal‚Äù
      let dial = root;
      if(suffixes.length){
        // Para +1 dejamos +1; para otros, root + 1er sufijo t√≠pico
        dial = (root === "+1") ? "+1" : (root + suffixes[0]);
      }

      const name = c.name?.common || iso2;
      const flagUrl = c.flags?.png || `https://flagcdn.com/w40/${iso2.toLowerCase()}.png`;

      list.push({ iso2, name, dial, flagUrl });
    }

    list.sort((a,b)=>{
      if(a.iso2==="ES") return -1;
      if(b.iso2==="ES") return 1;
      return a.name.localeCompare(b.name, "es");
    });

    countries = list;
  }

  function renderCountries(filterText){
    const q = (filterText || "").trim().toLowerCase();
    countriesList.innerHTML = "";

    const filtered = countries.filter(c=>{
      if(!q) return true;
      return c.name.toLowerCase().includes(q) || c.dial.includes(q) || c.iso2.toLowerCase().includes(q);
    });

    for(const c of filtered){
      const row = document.createElement("div");
      row.className = "flag-option";
      row.innerHTML = `
        <img src="${c.flagUrl}" alt="${c.iso2}">
        <div class="country-name">${c.name}</div>
        <div class="dial">${c.dial}</div>
      `;
      row.addEventListener("click",(e)=>{
        e.stopPropagation();
        setCountry(c.iso2, c.dial, c.flagUrl);
        closeDropdown();

        // reset tel√©fono y pista
        telInput.value = "";
        phoneHint.className = "hint";
        phoneHint.textContent = hintTextForMax();
      });
      countriesList.appendChild(row);
    }

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.style.padding = "10px 12px";
      empty.style.color = "#6b7280";
      empty.textContent = "No hay resultados.";
      countriesList.appendChild(empty);
    }
  }

  function setCountry(iso2, dial, flagUrl){
    selectedCountry = iso2.toUpperCase();
    selectedDial = dial;
    prefixEl.textContent = dial;
    currentFlag.src = flagUrl || `https://flagcdn.com/w40/${selectedCountry.toLowerCase()}.png`;
    currentFlag.alt = selectedCountry;

    // recalcular l√≠mite para ESTE pa√≠s
    currentMaxDigits = getMaxDigitsForCountry(selectedCountry);
  }

  async function detectCountryByIP(){
    try{
      const res = await fetch("https://ipapi.co/json/");
      const j = await res.json();
      const iso2 = (j.country_code || "").toUpperCase();
      if(!iso2) return;
      const found = countries.find(c=>c.iso2 === iso2);
      if(found) setCountry(found.iso2, found.dial, found.flagUrl);
    }catch{}
  }

  // ===== TEL√âFONO: bloqueo d√≠gitos + formato + validaci√≥n =====
  function rawDigits(){
    return telInput.value.replace(/[^\d]/g,"");
  }

  function formatAsYouType(){
    const digits = rawDigits();
    const ayt = new libphonenumber.AsYouType(selectedCountry);
    telInput.value = ayt.input(digits);
  }

  function clipToMaxDigits(){
    const digits = rawDigits();
    if(digits.length <= currentMaxDigits) return false;
    const clipped = digits.slice(0, currentMaxDigits);
    const ayt = new libphonenumber.AsYouType(selectedCountry);
    telInput.value = ayt.input(clipped);
    return true;
  }

  function validatePhone(showError){
    const digits = rawDigits();

    if(!digits){
      if(showError){
        phoneHint.className = "hint bad";
        phoneHint.textContent = "Introduce un n√∫mero.";
      }else{
        phoneHint.className = "hint";
        phoneHint.textContent = hintTextForMax();
      }
      return null;
    }

    try{
      const full = selectedDial + digits;
      const phone = libphonenumber.parsePhoneNumberFromString(full, selectedCountry);

      if(!phone || !phone.isValid()){
        if(showError){
          phoneHint.className = "hint bad";
          phoneHint.textContent = `N√∫mero no v√°lido para el pa√≠s seleccionado. M√°x: ${currentMaxDigits} d√≠gitos.`;
        }else{
          phoneHint.className = "hint";
          phoneHint.textContent = hintTextForMax();
        }
        return null;
      }

      phoneHint.className = "hint good";
      phoneHint.textContent = "N√∫mero v√°lido.";
      return phone;
    }catch{
      if(showError){
        phoneHint.className = "hint bad";
        phoneHint.textContent = `N√∫mero no v√°lido para el pa√≠s seleccionado. M√°x: ${currentMaxDigits} d√≠gitos.`;
      }
      return null;
    }
  }

  // Bloqueo duro para TODOS (seg√∫n pa√≠s seleccionado)
  telInput.addEventListener("beforeinput", (e)=>{
    if(e.inputType !== "insertText" && e.inputType !== "insertFromPaste") return;

    const incoming = (e.data ?? "").replace(/[^\d]/g,"");
    if(!incoming) return;

    const selectionStart = telInput.selectionStart ?? telInput.value.length;
    const selectionEnd = telInput.selectionEnd ?? telInput.value.length;

    const leftDigits = telInput.value.slice(0, selectionStart).replace(/[^\d]/g,"");
    const rightDigits = telInput.value.slice(selectionEnd).replace(/[^\d]/g,"");

    const nextLen = leftDigits.length + incoming.length + rightDigits.length;
    if(nextLen > currentMaxDigits){
      e.preventDefault();
    }
  });

  telInput.addEventListener("input", ()=>{
    formatAsYouType();
    clipToMaxDigits();
    validatePhone(false);
  });

  telInput.addEventListener("blur", ()=>{
    validatePhone(true);
  });

  // ===== INIT =====
  (async function init(){
    await loadCountries();
    renderCountries("");
    await detectCountryByIP();

    // aplicar max/hint tras autodetect
    currentMaxDigits = getMaxDigitsForCountry(selectedCountry);
    phoneHint.textContent = hintTextForMax();
  })();

  // ===== SUBMIT =====
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    statusEl.style.display = "none";

    // validaciones extra
    setMinDateToToday();
    enforceDateNotPast();

    // HTML required: si faltan campos, mostramos la UI nativa del navegador
    if(!form.checkValidity()){
      form.reportValidity();
      return;
    }

    const phone = validatePhone(true);
    if(!phone) return;

    // ‚úÖ QUIERES QUE EN SHEETS SE GUARDE CON ESPACIOS (SIN +34)
    const nationalPretty = phone.formatNational(); // ej: "654 65 46 44" o similar por pa√≠s
    const telefonoConEspacios = nationalPretty
      .replace(/[^\d]/g, " ")
      .replace(/\s+/g, " ")
      .trim();

    const data = {
      nombre: nombreEl.value.trim(),
      email: emailEl.value.trim(),
      telefono: telefonoConEspacios, // üëà SOLO N√öMERO CON ESPACIOS (sin +34)
      fecha_solicitada: fechaEl.value + "T" + horaEl.value,
      mensaje: document.getElementById("mensaje").value.trim()
    };

    try{
      const resp = await fetch(WEBHOOK, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data)
      });

      if(!resp.ok) throw new Error("HTTP " + resp.status);

      statusEl.className = "status ok";
      statusEl.textContent = "Cita enviada correctamente.";
      statusEl.style.display = "block";

      // reset sin perder pa√≠s/prefijo visual
      form.reset();
      telInput.value = "";
      phoneHint.className = "hint";
      phoneHint.textContent = hintTextForMax();

      // refresca min fecha por si cambi√≥ el d√≠a
      setMinDateToToday();

    }catch{
      statusEl.className = "status err";
      statusEl.textContent = "Error al enviar la cita.";
      statusEl.style.display = "block";
    }
  });
</script>

</body>
</html>
