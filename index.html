<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reserva tu cita</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f3f3f3;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    margin:0;
  }

  .container{
    background:#fff;
    padding:40px;
    border-radius:20px;
    width:420px;
    box-shadow:0 10px 30px rgba(0,0,0,.10);
    position:relative;
  }

  h2{
    text-align:center;
    font-size:32px;
    margin-bottom:30px;
  }

  .field{ margin-bottom:20px; }

  label{
    display:block;
    font-size:16px;
    margin-bottom:6px;
  }

  input, textarea, select{
    width:100%;
    padding:14px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:18px;
    box-sizing:border-box;
    outline:none;
    background:#fff;
  }

  input::placeholder, textarea::placeholder{
    color:#9aa0a6;
    opacity:1;
  }

  textarea{ resize:none; }

  /* TELÉFONO */
  .phone-wrapper{
    display:flex;
    border:1px solid #ccc;
    border-radius:12px;
    height:54px;
    background:#fff;
    position:relative;
    overflow:visible; /* para dropdown */
  }

  .flag-btn{
    width:70px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-right:1px solid #ddd;
    cursor:pointer;
    user-select:none;
    flex:0 0 70px;
  }

  .flag-btn img{
    width:28px;
    height:20px;
    border-radius:3px;
    object-fit:cover;
  }

  .prefix{
    display:flex;
    align-items:center;
    padding:0 10px;
    font-size:18px;
    color:#444;
    white-space:nowrap;
  }

  .phone-input{
    flex:1;
    border:none;
    outline:none;
    font-size:18px;
    padding:14px 14px 14px 6px;
    min-width:0;
  }

  /* Dropdown países (fuera del botón para que NO se rompa el click) */
  .flag-dropdown{
    position:absolute;
    top:60px;
    left:0;
    width:340px;
    max-height:320px;
    overflow:auto;
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    display:none;
    z-index:999999;
    border:1px solid #eee;
  }

  .dropdown-head{
    position:sticky;
    top:0;
    background:#fff;
    padding:10px;
    border-bottom:1px solid #eee;
  }

  .search{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:16px;
  }

  .flag-option{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    cursor:pointer;
  }

  .flag-option img{
    width:26px;
    height:18px;
    border-radius:3px;
    object-fit:cover;
  }

  .flag-option:hover{ background:#f3f5f9; }

  .country-name{
    flex:1;
    font-size:14px;
    color:#333;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .dial{
    font-size:14px;
    color:#111;
    font-weight:600;
    white-space:nowrap;
  }

  button{
    width:100%;
    padding:16px;
    border-radius:14px;
    border:none;
    background:#2f5bd7;
    color:#fff;
    font-size:22px;
    cursor:pointer;
    margin-top:8px;
  }
  button:hover{ background:#264cc0; }
  button:disabled{ opacity:.7; cursor:not-allowed; }

  .status{
    margin-top:12px;
    font-size:16px;
    display:none;
  }
  .status.ok{ color:#15803d; display:block; }
  .status.err{ color:#b91c1c; display:block; }

  .hint{
    display:block;
    margin-top:8px;
    font-size:13px;
    color:#6b7280;
  }
  .hint.bad{ color:#b91c1c; }
  .hint.good{ color:#15803d; }
</style>

<!-- libphonenumber-js (validación + formateo por país) -->
<script src="https://unpkg.com/libphonenumber-js@1.11.7/bundle/libphonenumber-js.min.js"></script>
</head>
<body>

<div class="container">
  <h2>Reserva tu cita</h2>

  <form id="form" autocomplete="on">

    <div class="field">
      <label>Nombre</label>
      <input id="nombre" name="nombre" type="text" placeholder="Nombre completo" required />
    </div>

    <div class="field">
      <label>Correo electrónico</label>
      <input id="email" name="email" type="email" placeholder="Correo electrónico" required />
    </div>

    <div class="field">
      <label>Teléfono</label>

      <div class="phone-wrapper" id="phoneWrapper">
        <div class="flag-btn" id="flagBtn" title="Cambiar país" aria-label="Cambiar país">
          <img id="currentFlag" src="https://flagcdn.com/w40/es.png" alt="España" />
        </div>

        <div class="prefix" id="prefix">+34</div>

        <input id="telefono" name="telefono" class="phone-input" type="tel" placeholder="654 654 654" required />

        <div class="flag-dropdown" id="flagDropdown">
          <div class="dropdown-head">
            <input id="countrySearch" class="search" type="text" placeholder="Buscar país o prefijo (+34)" />
          </div>
          <div id="countriesList"></div>
        </div>
      </div>

      <small id="phoneHint" class="hint">Introduce un número válido.</small>
    </div>

    <div class="field">
      <label>Selecciona el día</label>
      <input id="fecha" name="fecha" type="date" required />
    </div>

    <div class="field">
      <label>Selecciona la hora</label>
      <select id="hora" name="hora" required></select>
    </div>

    <div class="field">
      <label>Motivo</label>
      <textarea id="mensaje" name="mensaje" rows="3" placeholder="Escribe el motivo de la cita" required></textarea>
    </div>

    <button type="submit" id="submitBtn">Reservar</button>
    <div id="status" class="status"></div>

  </form>
</div>

<script>
  /* ===== CONFIG ===== */
  const WEBHOOK_PROD = "https://primary-production-4f93b.up.railway.app/webhook/cb0b99ce-d952-4988-84fd-708c61c1d9e6";

  /* ===== ELEMENTS ===== */
  const phoneWrapper = document.getElementById("phoneWrapper");
  const flagBtn = document.getElementById("flagBtn");
  const dropdown = document.getElementById("flagDropdown");
  const currentFlag = document.getElementById("currentFlag");
  const prefixEl = document.getElementById("prefix");
  const telInput = document.getElementById("telefono");
  const phoneHint = document.getElementById("phoneHint");
  const statusEl = document.getElementById("status");
  const submitBtn = document.getElementById("submitBtn");
  const countrySearch = document.getElementById("countrySearch");
  const countriesList = document.getElementById("countriesList");

  /* ===== STATE ===== */
  let selectedCountry = "ES"; // ISO2
  let selectedDial = "+34";
  let countries = []; // { iso2, name, dial, flagUrl }

  /* ===== DATE MIN TODAY (cada día se actualiza solo) ===== */
  const fecha = document.getElementById("fecha");
  const today = new Date();
  today.setHours(0,0,0,0);
  fecha.min = today.toISOString().split("T")[0];

  /* ===== HOURS 06:00 - 23:30 + 00:00 (slots 30 min) ===== */
  const hora = document.getElementById("hora");
  function fillHours(){
    hora.innerHTML = "";
    for (let h=6; h<24; h++){
      ["00","30"].forEach(m=>{
        const t = String(h).padStart(2,"0")+":"+m;
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        hora.appendChild(opt);
      });
    }
    // Añadimos 00:00 (medianoche) como opción final
    const opt00 = document.createElement("option");
    opt00.value = "00:00";
    opt00.textContent = "00:00";
    hora.appendChild(opt00);
  }
  fillHours();

  /* ===== Dropdown open/close (sin romper el click en opciones) ===== */
  function openDropdown(){
    dropdown.style.display = "block";
    countrySearch.value = "";
    renderCountries("");
    setTimeout(()=>countrySearch.focus(), 0);
  }
  function closeDropdown(){
    dropdown.style.display = "none";
  }

  flagBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    if (dropdown.style.display === "block") closeDropdown();
    else openDropdown();
  });

  // Clicar dentro del dropdown no debe cerrarlo
  dropdown.addEventListener("click", (e)=> e.stopPropagation());
  countrySearch.addEventListener("click", (e)=> e.stopPropagation());

  // Clicar fuera cierra
  document.addEventListener("click", ()=> closeDropdown());

  /* ===== Load ALL countries (RestCountries) ===== */
  async function loadCountries(){
    const res = await fetch("https://restcountries.com/v3.1/all?fields=cca2,name,idd,flags");
    if(!res.ok) throw new Error("No se pudieron cargar países");
    const data = await res.json();

    const list = [];
    for(const c of data){
      const iso2 = (c.cca2 || "").toUpperCase();
      if(!iso2) continue;

      const root = c.idd?.root || "";
      const suffixes = c.idd?.suffixes || [];
      if(!root || !root.startsWith("+")) continue;

      // Para UI:
      // - Si hay suffixes: en muchos países root+primer sufijo está bien.
      // - USA/CAN (+1) tiene muchas zonas; mostramos +1 y validamos por país igualmente.
      let dial = root;
      if(suffixes.length){
        dial = (root === "+1") ? "+1" : (root + suffixes[0]);
      }

      const name = c.name?.common || iso2;
      const flagUrl = c.flags?.png || `https://flagcdn.com/w40/${iso2.toLowerCase()}.png`;

      list.push({ iso2, name, dial, flagUrl });
    }

    list.sort((a,b)=>{
      if(a.iso2==="ES") return -1;
      if(b.iso2==="ES") return 1;
      return a.name.localeCompare(b.name, "es");
    });

    countries = list;
  }

  function renderCountries(filterText){
    const q = (filterText || "").trim().toLowerCase();
    countriesList.innerHTML = "";

    const filtered = countries.filter(c=>{
      if(!q) return true;
      return c.name.toLowerCase().includes(q) || c.dial.includes(q) || c.iso2.toLowerCase().includes(q);
    });

    // Renderizamos TODOS (scroll + buscador)
    for(const c of filtered){
      const row = document.createElement("div");
      row.className = "flag-option";
      row.innerHTML = `
        <img src="${c.flagUrl}" alt="${c.iso2}">
        <div class="country-name">${c.name}</div>
        <div class="dial">${c.dial}</div>
      `;
      row.addEventListener("click", (e)=>{
        e.stopPropagation();            // clave: evita que el click cierre/abra raro
        setCountry(c.iso2, c.dial, c.flagUrl);
        closeDropdown();
        enforceMaxDigitsHard();         // por si ya estaba largo
        formatAsYouType();
        validatePhone(false);
      });
      countriesList.appendChild(row);
    }

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.style.padding = "10px 12px";
      empty.style.color = "#6b7280";
      empty.textContent = "No hay resultados.";
      countriesList.appendChild(empty);
    }
  }

  countrySearch.addEventListener("input", (e)=> renderCountries(e.target.value));

  function setCountry(iso2, dial, flagUrl){
    selectedCountry = iso2.toUpperCase();
    selectedDial = dial;
    prefixEl.textContent = dial;
    currentFlag.src = flagUrl || `https://flagcdn.com/w40/${selectedCountry.toLowerCase()}.png`;
    currentFlag.alt = selectedCountry;
  }

  /* ===== Auto-detect country by IP ===== */
  async function detectCountryByIP(){
    try{
      const res = await fetch("https://ipapi.co/json/");
      if(!res.ok) throw new Error("ipapi fail");
      const j = await res.json();
      const iso2 = (j.country_code || "").toUpperCase();
      if(!iso2) throw new Error("no country_code");
      const found = countries.find(c=>c.iso2 === iso2);
      if(found) setCountry(found.iso2, found.dial, found.flagUrl);
    }catch{
      // se queda en ES
    }
  }

  /* ===== PHONE: format + validation + “bloqueo” de dígitos cuando ya es válido ===== */

  function rawDigits(){
    return telInput.value.replace(/[^\d]/g,"");
  }

  function formatAsYouType(){
    const digits = rawDigits();
    const ayt = new libphonenumber.AsYouType(selectedCountry);
    telInput.value = ayt.input(digits);
  }

  // Si el número ya es válido, no dejamos meter más dígitos (cumple el “máximo por país” sin inventar longitudes)
  function enforceMaxDigitsSoft(){
    const digits = rawDigits();
    if(!digits) return;

    const full = `${selectedDial}${digits}`;
    try{
      const phone = libphonenumber.parsePhoneNumberFromString(full, selectedCountry);
      if(phone && phone.isValid()){
        const max = String(phone.nationalNumber).length;
        if(digits.length > max){
          const clipped = digits.slice(0, max);
          const ayt = new libphonenumber.AsYouType(selectedCountry);
          telInput.value = ayt.input(clipped);
        }
      }
    }catch{}
  }

  function enforceMaxDigitsHard(){
    // recorta incluso si está “casi” válido: si al recortar se hace válido, lo deja limpio
    const digits = rawDigits();
    if(!digits) return;
    for(let cut = digits.length; cut >= 1; cut--){
      const attempt = digits.slice(0, cut);
      const full = `${selectedDial}${attempt}`;
      try{
        const phone = libphonenumber.parsePhoneNumberFromString(full, selectedCountry);
        if(phone && phone.isValid()){
          const ayt = new libphonenumber.AsYouType(selectedCountry);
          telInput.value = ayt.input(attempt);
          return;
        }
      }catch{}
    }
  }

  function validatePhone(showError=true){
    const digits = rawDigits();

    if(!digits){
      if(showError){
        phoneHint.className = "hint bad";
        phoneHint.textContent = "Introduce un número.";
      }
      return null;
    }

    const full = `${selectedDial}${digits}`;

    try{
      const phone = libphonenumber.parsePhoneNumberFromString(full, selectedCountry);
      if(!phone || !phone.isValid()){
        if(showError){
          phoneHint.className = "hint bad";
          phoneHint.textContent = "Número no válido para el país seleccionado.";
        }
        return null;
      }

      phoneHint.className = "hint good";
      phoneHint.textContent = `Válido: ${phone.formatInternational()}`;
      return phone; // objeto phone
    }catch{
      if(showError){
        phoneHint.className = "hint bad";
        phoneHint.textContent = "Número no válido para el país seleccionado.";
      }
      return null;
    }
  }

  telInput.addEventListener("input", ()=>{
    formatAsYouType();
    enforceMaxDigitsSoft();
    validatePhone(false);
  });

  telInput.addEventListener("blur", ()=>{
    enforceMaxDigitsHard();
    validatePhone(true);
  });

  /* ===== INIT ===== */
  (async function init(){
    try{
      await loadCountries();
      renderCountries("");
      await detectCountryByIP();
      formatAsYouType();
      validatePhone(false);
    }catch{
      // fallback ES sin romper
    }
  })();

  /* ===== SUBMIT ===== */
  document.getElementById("form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    statusEl.style.display = "none";

    const phone = validatePhone(true);
    if(!phone) return;

    // >>> LO QUE SE GUARDA EN SHEETS: SOLO NÚMERO NACIONAL CON ESPACIOS <<<
    // (sin +34). Visualmente se sigue viendo +34 delante.
    const nacionalConEspacios = phone.formatNational(); // ej: 654 654 654 (depende del país)
    const nacionalSoloDigitos = String(phone.nationalNumber); // por si lo quieres después

    submitBtn.disabled = true;
    submitBtn.textContent = "Enviando...";

    try{
      const data = {
        nombre: nombre.value.trim(),
        email: email.value.trim(),
        telefono: nacionalConEspacios,                 // <-- SOLO número nacional (lo que quieres en Sheets)
        fecha_solicitada: fecha.value + "T" + hora.value,
        mensaje: mensaje.value.trim(),
        // extra (no molesta): para futuras integraciones WhatsApp/Calendar
        pais: selectedCountry,
        prefijo: selectedDial,
        telefono_nacional_digitos: nacionalSoloDigitos
      };

      const res = await fetch(WEBHOOK_PROD, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data)
      });

      if(!res.ok) throw new Error("Webhook fail");

      statusEl.className = "status ok";
      statusEl.textContent = "Cita enviada correctamente.";
      statusEl.style.display = "block";

      // Reset sin perder el país detectado
      document.getElementById("form").reset();
      // mantenemos prefijo/bandera y estado teléfono
      setTimeout(()=>{
        // deja el input vacío con placeholder (como antes)
        telInput.value = "";
        phoneHint.className = "hint";
        phoneHint.textContent = "Introduce un número válido.";
      }, 0);

    }catch{
      statusEl.className = "status err";
      statusEl.textContent = "Error al enviar la cita.";
      statusEl.style.display = "block";
    }

    submitBtn.disabled = false;
    submitBtn.textContent = "Reservar";
  });
</script>

</body>
</html>
